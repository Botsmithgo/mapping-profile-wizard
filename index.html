<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HeyDonto — Mapping Profile Setup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Ant Design -->
  <script src="https://unpkg.com/dayjs@1.11.13/dayjs.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/antd@5.22.6/dist/reset.css">
  <script src="https://unpkg.com/antd@5.22.6/dist/antd.min.js"></script>
  <script src="https://unpkg.com/@ant-design/icons@5.5.2/dist/index.umd.min.js"></script>

  <style>
    /* ── Design Tokens ────────────────────────────── */
    :root {
      --primary: #0891b2;
      --primary-hover: #0e7490;
      --primary-light: rgba(8, 145, 178, 0.08);
      --primary-ring: rgba(8, 145, 178, 0.18);
      --success: #10b981;
      --success-light: #dcfce7;
      --success-border: #bbf7d0;
      --success-text: #166534;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --warning-border: #fde68a;
      --warning-text: #92400e;
      --error: #ef4444;
      --error-light: #fee2e2;
      --gray-50: #fafbfc;
      --gray-100: #f5f7fa;
      --gray-150: #f0f1f3;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #1a1a1a;
      --white: #fff;
      --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px; --sp-5: 20px;
      --sp-6: 24px; --sp-8: 32px; --sp-10: 40px; --sp-12: 48px; --sp-16: 64px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Courier New', monospace;
      --text-xs: 11px; --text-sm: 12px; --text-base: 13px; --text-md: 14px;
      --text-lg: 15px; --text-xl: 18px; --text-2xl: 24px;
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.09), 0 2px 6px rgba(0,0,0,0.04);
      --radius-sm: 6px; --radius-md: 8px; --radius-lg: 12px; --radius-full: 9999px;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
      --duration: 0.2s; --duration-fast: 0.15s;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font) !important;
      background: var(--gray-100); color: var(--gray-900);
      -webkit-font-smoothing: antialiased; min-height: 100vh;
      line-height: 1.5; font-variant-numeric: tabular-nums;
    }

    /* ── antd overrides for visual fidelity ────────── */
    .ant-btn { font-family: var(--font); border-radius: var(--radius-md); font-weight: 500; }
    .ant-table { font-family: var(--font); }
    .ant-table-thead > tr > th { font-size: 10px !important; font-weight: 600 !important; color: var(--gray-500) !important; text-transform: uppercase; letter-spacing: .5px; background: var(--gray-50) !important; padding: 10px 16px !important; }
    .ant-table-tbody > tr > td { font-size: var(--text-sm); padding: 10px 16px !important; }
    .ant-table-tbody > tr:hover > td { background: var(--primary-light) !important; }
    .ant-table-tbody > tr.needs-attention > td { background: #fffbeb !important; }
    .ant-table-tbody > tr.needs-attention:hover > td { background: #fef3c7 !important; }
    .ant-table-tbody > tr.needs-attention > td:first-child { box-shadow: inset 3px 0 0 var(--warning); }
    .ant-collapse { border-radius: var(--radius-md) !important; }
    .ant-collapse-item { border-radius: var(--radius-md) !important; overflow: hidden; }
    .ant-select { font-family: var(--font); }
    .ant-input { font-family: var(--font); }
    .ant-tag { font-family: var(--font); }
    .ant-steps .ant-steps-item-title { font-size: var(--text-sm) !important; font-weight: 500 !important; }
    .ant-steps .ant-steps-item-icon { font-weight: 600 !important; }
    .ant-alert { border-radius: var(--radius-md); }

    /* ── Focus states ─────────────────────────────── */
    *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    /* ── Top bar ─────────────────────────────────── */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      background: var(--white);
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      padding: 0 var(--sp-8); height: 56px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .topbar-left { display: flex; align-items: center; gap: var(--sp-3); }
    .topbar-back {
      display: flex; align-items: center; gap: var(--sp-1);
      font-size: var(--text-base); font-weight: 500; color: var(--gray-500);
      background: none; border: none; cursor: pointer;
      padding: var(--sp-2) var(--sp-3); border-radius: var(--radius-sm);
      transition: all var(--duration-fast) var(--ease); font-family: inherit;
    }
    .topbar-back:hover { background: var(--gray-150); color: var(--gray-700); }
    .topbar-divider { width: 1px; height: 20px; background: var(--gray-200); }
    .topbar-title { font-size: var(--text-lg); font-weight: 600; color: var(--gray-900); letter-spacing: -0.01em; }
    .topbar-right { display: flex; align-items: center; gap: var(--sp-3); }
    .draft-indicator { font-size: var(--text-xs); color: var(--gray-500); display: flex; align-items: center; gap: var(--sp-1); }
    .draft-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--warning); }

    /* ── Stepper bar ──────────────────────────────── */
    .stepper-bar-wrap {
      background: var(--white);
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
      padding: var(--sp-3) var(--sp-8);
      display: flex; align-items: center; justify-content: center;
    }
    .stepper-bar-wrap .ant-steps { max-width: 800px; width: 100%; }

    /* ── Page body ────────────────────────────────── */
    .page-body { max-width: 1120px; margin: 0 auto; padding: var(--sp-8); }
    .page-body.narrow { max-width: 720px; }
    .page-body.wide { max-width: 1280px; padding: var(--sp-6) var(--sp-8); }

    /* ── Footer bar ──────────────────────────────── */
    .footer-bar {
      position: sticky; bottom: 0; z-index: 100;
      background: var(--white);
      box-shadow: 0 -1px 0 rgba(0,0,0,0.06);
      padding: var(--sp-4) var(--sp-8);
      display: flex; align-items: center; justify-content: space-between;
    }
    .footer-left { display: flex; align-items: center; gap: var(--sp-2); }
    .footer-right { display: flex; align-items: center; gap: var(--sp-3); }

    /* Step content transition */
    .step-content { animation: stepFadeIn 0.35s var(--ease); }
    @keyframes stepFadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* ── Section headings ─────────────────────────── */
    .section-heading { font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--sp-1); letter-spacing: -0.01em; }
    .section-sub { font-size: var(--text-base); color: var(--gray-500); margin-bottom: var(--sp-6); }

    /* ── Upload (Step 1) ─────────────────────────── */
    .upload-zone {
      border: 1.5px dashed var(--gray-300); border-radius: var(--radius-lg);
      padding: var(--sp-16) var(--sp-8); text-align: center;
      cursor: pointer; transition: all var(--duration) var(--ease); background: var(--gray-50);
    }
    .upload-zone:hover { border-color: var(--primary); background: rgba(8, 145, 178, 0.03); box-shadow: 0 0 0 4px var(--primary-light); }
    .upload-icon {
      width: 52px; height: 52px; border-radius: var(--radius-lg);
      background: var(--primary); color: var(--white);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto var(--sp-4);
    }
    .upload-title { font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--sp-1); }
    .upload-sub { font-size: var(--text-base); color: var(--gray-500); margin-bottom: var(--sp-2); }
    .upload-formats { font-size: var(--text-sm); color: var(--gray-400); }

    .file-list { margin-top: var(--sp-6); }
    .file-list-title { font-size: var(--text-xs); font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: .5px; margin-bottom: var(--sp-3); }
    .file-item {
      display: flex; align-items: center; gap: var(--sp-3);
      padding: var(--sp-3) var(--sp-4); background: var(--white);
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      margin-bottom: var(--sp-2); transition: all var(--duration-fast) var(--ease);
    }
    .file-item:hover { box-shadow: var(--shadow-sm); border-color: var(--gray-300); }
    .file-icon-sm {
      width: 36px; height: 36px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center; font-size: var(--text-base);
    }
    .file-icon-sm.csv { background: var(--success-light); color: #16a34a; }
    .file-icon-sm.json { background: var(--warning-light); color: #d97706; }
    .file-icon-sm.xlsx { background: #dbeafe; color: #2563eb; }
    .file-info { flex: 1; }
    .file-name { font-size: var(--text-base); font-weight: 500; }
    .file-size { font-size: var(--text-xs); color: var(--gray-500); }
    .file-remove {
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      border: none; background: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--gray-400); transition: all var(--duration-fast) var(--ease);
    }
    .file-remove:hover { background: var(--error-light); color: var(--error); }

    .detected-source {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: var(--sp-4); padding: var(--sp-3) var(--sp-4);
      background: #f0fdf4; border: 1px solid var(--success-border); border-radius: var(--radius-md);
    }
    .detected-left { display: flex; align-items: center; gap: var(--sp-2); }
    .detected-label { font-size: var(--text-base); color: var(--success-text); }
    .detected-value { font-size: var(--text-base); font-weight: 600; color: var(--success-text); }
    .detected-select {
      padding: var(--sp-2) var(--sp-3); border-radius: var(--radius-sm);
      border: 1px solid var(--success-border); background: var(--white);
      font-size: var(--text-sm); color: var(--success-text); font-family: inherit;
      cursor: pointer;
    }

    /* ── Step 2: Classification ──────────────────── */
    .review-header { margin-bottom: var(--sp-4); }
    .review-title { font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--sp-1); letter-spacing: -0.01em; }
    .review-sub { font-size: var(--text-base); color: var(--gray-500); }

    .search-row { display: flex; align-items: center; gap: var(--sp-3); margin-bottom: var(--sp-3); }
    .results-count { font-size: var(--text-sm); color: var(--gray-500); margin-bottom: var(--sp-3); padding: 0 var(--sp-1); }
    .results-count strong { font-weight: 600; color: var(--gray-500); }

    /* File row collapse panels */
    .file-collapse .ant-collapse-item { border: 1px solid var(--gray-200) !important; border-radius: var(--radius-md) !important; margin-bottom: var(--sp-2); background: var(--white); box-shadow: var(--shadow-xs); transition: all var(--duration) var(--ease); overflow: hidden; }
    .file-collapse .ant-collapse-item:hover { box-shadow: var(--shadow-sm); border-color: var(--gray-300) !important; }
    .file-collapse .ant-collapse-item-active { border-color: var(--primary) !important; box-shadow: var(--shadow-md); }
    .file-collapse .ant-collapse-header { padding: var(--sp-3) var(--sp-4) !important; }
    .file-collapse .ant-collapse-content-box { padding: 0 !important; }
    .file-collapse .ant-collapse-item-active .ant-collapse-header { background: rgba(8, 145, 178, 0.03); }

    .file-panel-header {
      display: grid; grid-template-columns: 30px 1fr 100px 52px 58px 64px;
      align-items: center; gap: var(--sp-3); width: 100%;
    }
    .file-panel-header-labels {
      display: grid; grid-template-columns: 30px 1fr 100px 52px 58px 64px;
      align-items: center; gap: var(--sp-3);
      padding: var(--sp-1) var(--sp-4) var(--sp-1) 56px;
      font-size: 10px; font-weight: 600; color: var(--gray-400);
      text-transform: uppercase; letter-spacing: .5px; margin-bottom: var(--sp-1);
    }
    .file-panel-header-labels span:nth-child(n+3) { text-align: right; }
    .file-row-icon {
      width: 30px; height: 30px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; font-size: var(--text-sm);
    }
    .file-row-icon.csv { background: var(--success-light); color: #16a34a; }
    .file-row-icon.json { background: var(--warning-light); color: #d97706; }
    .file-row-icon.xlsx { background: #dbeafe; color: #2563eb; }
    .file-row-name { font-size: var(--text-base); font-weight: 500; color: var(--gray-900); display: flex; align-items: center; gap: var(--sp-2); min-width: 0; overflow: hidden; }
    .file-row-field-count {
      font-size: 10px; font-weight: 500; color: var(--gray-400);
      background: var(--gray-100); padding: 1px 7px; border-radius: var(--radius-full); white-space: nowrap;
    }
    .file-row-col { display: flex; align-items: center; justify-content: flex-end; }
    .shape-tag { font-size: 10px; color: var(--gray-500); }

    /* Expanded body */
    .file-row-body-inner { padding: var(--sp-4); border-top: 1px solid var(--gray-200); }
    .file-meta-pills { display: flex; align-items: center; gap: var(--sp-2); margin-bottom: var(--sp-3); }
    .meta-pill { font-size: 10px; color: var(--gray-500); background: var(--gray-150); padding: 3px 8px; border-radius: var(--radius-sm); }

    /* Fields table custom styles */
    .field-name { font-family: var(--font-mono); font-size: var(--text-xs); font-weight: 500; color: var(--gray-700); }
    .type-badge {
      font-family: var(--font-mono); font-size: 10px; font-weight: 500;
      color: var(--gray-500); background: var(--gray-100);
      padding: 2px 6px; border-radius: 3px;
    }
    .semantic-label { font-weight: 500; color: var(--primary); font-size: var(--text-sm); }
    .relation-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 9px; font-weight: 600; font-family: var(--font-mono);
      padding: 1px 6px; border-radius: 3px; margin-left: 6px; vertical-align: middle; white-space: nowrap;
    }
    .relation-badge.pk { background: #ede9fe; color: #7c3aed; border: 1px solid #ddd6fe; }
    .relation-badge.fk { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .sample-chip {
      display: inline-block; padding: 1px 7px;
      border-radius: var(--radius-full); border: 1px solid var(--gray-200); background: var(--gray-50);
      font-family: var(--font-mono); font-size: 10px; color: var(--gray-600);
      max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* Schema viewer */
    .schema-viewer {
      background: var(--gray-50); border: 1px solid var(--gray-200);
      border-radius: var(--radius-md); padding: var(--sp-4) var(--sp-5);
      overflow-x: auto; font-family: var(--font-mono); font-size: 11px;
      line-height: 1.7; color: var(--gray-700);
    }
    .schema-viewer .json-key { color: #0e7490; }
    .schema-viewer .json-string { color: #16a34a; }
    .schema-viewer .json-type { color: #c2410c; }
    .schema-viewer .json-bracket { color: var(--gray-400); }
    .schema-label { font-size: 10px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 8px; }

    .file-row-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--sp-2) var(--sp-4); background: var(--gray-50); border-top: 1px solid var(--gray-150);
    }
    .show-all-toggle {
      font-family: inherit; font-size: var(--text-xs); font-weight: 500;
      color: var(--primary); background: none; border: none;
      cursor: pointer; padding: var(--sp-1);
    }
    .show-all-toggle:hover { color: var(--primary-hover); }

    .empty-state { text-align: center; padding: var(--sp-12) var(--sp-6); }
    .empty-state-text { font-size: var(--text-base); color: var(--gray-500); margin-bottom: var(--sp-4); }

    /* ── Config preview (Step 3) ──────────────────── */
    .config-preview {
      margin-top: var(--sp-6); background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm);
      animation: fadeSlideIn 0.3s var(--ease);
    }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .config-preview-header {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-3) var(--sp-5); background: #f0fdf4;
      border-bottom: 1px solid var(--success-border); color: var(--success-text);
    }
    .config-preview-icon { display: flex; align-items: center; }
    .config-preview-title { font-size: var(--text-sm); font-weight: 600; }
    .config-preview-body { padding: 0; }
    .config-preview-row {
      display: flex; align-items: center; padding: var(--sp-3) var(--sp-5); border-bottom: 1px solid var(--gray-150);
    }
    .config-preview-label {
      font-size: var(--text-xs); font-weight: 600; color: var(--gray-500);
      text-transform: uppercase; letter-spacing: .4px; width: 80px; flex-shrink: 0;
    }
    .config-preview-value { font-size: var(--text-sm); font-weight: 500; color: var(--gray-700); display: flex; align-items: center; }
    .preview-code {
      font-family: var(--font-mono); font-size: 10px; font-weight: 600;
      background: var(--gray-100); padding: 2px 6px; border-radius: 3px; color: var(--gray-600);
    }

    /* ── Summary cards ───────────────────────────── */
    .summary-card {
      background: var(--white); border: none; border-radius: var(--radius-lg);
      overflow: hidden; margin-bottom: var(--sp-5); box-shadow: var(--shadow-sm);
    }
    .summary-card:last-child { margin-bottom: 0; }
    .summary-card-header {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-4) var(--sp-5); background: var(--gray-50); border-bottom: 1px solid var(--gray-150);
    }
    .summary-card-icon {
      width: 26px; height: 26px; border-radius: var(--radius-sm);
      background: var(--primary-light); color: var(--primary);
      display: flex; align-items: center; justify-content: center;
    }
    .summary-card-title { font-size: var(--text-base); font-weight: 600; }
    .summary-row {
      display: flex; align-items: flex-start;
      padding: var(--sp-3) var(--sp-5); border-bottom: 1px solid var(--gray-150);
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label { font-size: var(--text-sm); color: var(--gray-500); width: 160px; flex-shrink: 0; padding-top: 1px; }
    .summary-value { font-size: var(--text-base); font-weight: 500; color: var(--gray-900); flex: 1; }

    /* ── Generate area ───────────────────────────── */
    .generate-area {
      text-align: center; padding: var(--sp-8) var(--sp-6);
      border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
      margin-top: var(--sp-5); background: var(--white);
    }
    .generate-title { font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--sp-1); }
    .generate-sub { font-size: var(--text-base); color: var(--gray-500); margin-bottom: var(--sp-5); }
    .btn-generate {
      font-family: inherit; font-size: var(--text-md); font-weight: 600;
      padding: 14px 28px; border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--primary), #06b6d4); color: var(--white);
      border: none; cursor: pointer; display: inline-flex; align-items: center; gap: var(--sp-2);
      box-shadow: 0 4px 14px rgba(8, 145, 178, 0.3);
      transition: all var(--duration) var(--ease);
    }
    .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4); }

    /* ── States ───────────────────────────────────── */
    .state-box { text-align: center; padding: var(--sp-16) var(--sp-6); }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--gray-200); border-top-color: var(--primary);
      border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto var(--sp-5);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .state-title { font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--sp-2); }
    .state-sub { font-size: var(--text-base); color: var(--gray-500); }
    .success-circle {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      color: var(--white); display: flex; align-items: center; justify-content: center;
      margin: 0 auto var(--sp-5); animation: scaleIn .4s var(--ease);
    }
    @keyframes scaleIn { from { transform: scale(0); } 70% { transform: scale(1.15); } to { transform: scale(1); } }

    /* ── Form (Step 3, 6) ────────────────────────── */
    .form-section { margin-bottom: var(--sp-8); }
    .form-section:last-child { margin-bottom: 0; }
    .form-label { font-size: var(--text-base); font-weight: 600; color: var(--gray-700); margin-bottom: var(--sp-2); display: block; }
    .form-hint { font-size: var(--text-sm); color: var(--gray-500); margin-top: var(--sp-2); }

    /* ── Source Cards (Step 1) ──────────────────── */
    .sources-grid { display: flex; flex-direction: column; gap: var(--sp-3); }
    .source-card {
      display: flex; align-items: center; gap: var(--sp-4);
      padding: var(--sp-4) var(--sp-5); background: var(--white);
      border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xs); transition: all var(--duration) var(--ease);
      animation: cardSlideIn 0.3s var(--ease);
    }
    @keyframes cardSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .source-card:hover { box-shadow: var(--shadow-sm); border-color: var(--gray-300); }
    .source-card-icon {
      width: 44px; height: 44px; border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px;
    }
    .source-card-icon.files { background: linear-gradient(135deg, #dcfce7, #d1fae5); color: #16a34a; }
    .source-card-icon.database { background: linear-gradient(135deg, #dbeafe, #e0e7ff); color: #2563eb; }
    .source-card-icon.warehouse { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
    .source-card-icon.api { background: linear-gradient(135deg, #fce7f3, #fce4ec); color: #db2777; }
    .source-card-icon.stream { background: linear-gradient(135deg, #ede9fe, #e0e7ff); color: #7c3aed; }
    .source-card-icon.ehr { background: linear-gradient(135deg, #ecfeff, #cffafe); color: #0891b2; }
    .source-card-info { flex: 1; min-width: 0; }
    .source-card-name { font-size: var(--text-md); font-weight: 600; color: var(--gray-900); margin-bottom: 2px; }
    .source-card-meta { font-size: var(--text-xs); color: var(--gray-500); display: flex; align-items: center; gap: var(--sp-3); flex-wrap: wrap; }
    .source-card-tag { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-full); background: var(--gray-100); color: var(--gray-600); }
    .source-card-tag.connected { background: var(--success-light); color: var(--success-text); }
    .source-card-remove {
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      border: none; background: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--gray-400); transition: all var(--duration-fast) var(--ease); flex-shrink: 0;
    }
    .source-card-remove:hover { background: var(--error-light); color: var(--error); }

    .add-source-btn {
      display: flex; align-items: center; justify-content: center; gap: var(--sp-2);
      padding: var(--sp-5); background: var(--white); width: 100%;
      border: 2px dashed var(--gray-300); border-radius: var(--radius-lg);
      cursor: pointer; font-family: inherit; font-size: var(--text-md); font-weight: 500;
      color: var(--gray-500); transition: all var(--duration) var(--ease);
    }
    .add-source-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(8,145,178,0.02); }
    .add-source-btn .plus-circle {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--gray-100); display: flex; align-items: center; justify-content: center;
      transition: all var(--duration) var(--ease);
    }
    .add-source-btn:hover .plus-circle { background: var(--primary); color: var(--white); }

    /* Category / connector list */
    .category-list { display: flex; flex-direction: column; gap: var(--sp-2); animation: cardSlideIn 0.25s var(--ease); }
    .category-item {
      display: flex; align-items: center; gap: var(--sp-4);
      padding: var(--sp-4) var(--sp-5); background: var(--white);
      border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
      cursor: pointer; font-family: inherit; text-align: left;
      transition: all var(--duration-fast) var(--ease); box-shadow: var(--shadow-xs);
    }
    .category-item:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }
    .category-item:active { transform: scale(0.99); }
    .category-item.expanded { border-color: var(--primary); box-shadow: var(--shadow-md); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    .category-item-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; }
    .category-item-info { flex: 1; min-width: 0; }
    .category-item-name { font-size: var(--text-md); font-weight: 600; color: var(--gray-900); margin-bottom: 1px; }
    .category-item-desc { font-size: var(--text-xs); color: var(--gray-500); }
    .category-item-count { font-size: var(--text-xs); font-weight: 500; color: var(--gray-400); background: var(--gray-100); padding: 2px 8px; border-radius: var(--radius-full); }
    .category-item-chevron { color: var(--gray-300); transition: all var(--duration-fast) var(--ease); display: flex; align-items: center; }
    .category-item:hover .category-item-chevron { color: var(--primary); }
    .back-to-cats {
      display: flex; align-items: center; gap: var(--sp-2);
      font-family: inherit; font-size: var(--text-sm); font-weight: 500;
      color: var(--gray-500); background: none; border: none; cursor: pointer;
      padding: var(--sp-2) var(--sp-3); border-radius: var(--radius-sm);
    }
    .back-to-cats:hover { color: var(--gray-700); background: var(--gray-100); }

    .connector-sub { border: 1px solid var(--gray-200); border-top: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg); overflow: hidden; }
    .connector-sub-inner { padding: var(--sp-2); }
    .connector-sub-item {
      display: flex; align-items: center; gap: var(--sp-3);
      padding: var(--sp-3) var(--sp-4); border-radius: var(--radius-md);
      background: none; border: none; cursor: pointer; font-family: inherit;
      text-align: left; width: 100%; transition: background var(--duration-fast) var(--ease);
    }
    .connector-sub-item:hover { background: var(--gray-50); }
    .connector-sub-item-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .connector-sub-item-name { font-size: var(--text-md); font-weight: 500; color: var(--gray-900); }
    .connector-sub-item-desc { flex: 1; font-size: var(--text-xs); color: var(--gray-500); }
    .connector-sub-item-arrow { color: var(--gray-300); display: flex; }
    .connector-sub-item:hover .connector-sub-item-arrow { color: var(--primary); }

    .source-summary-bar {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-3) var(--sp-4); background: #f0fdf4;
      border: 1px solid var(--success-border); border-radius: var(--radius-md);
      font-size: var(--text-sm); color: var(--success-text); font-weight: 500;
      margin-top: var(--sp-4);
    }

    .empty-hero { text-align: center; padding: var(--sp-6) var(--sp-6) 0; }
    .empty-hero-sub { font-size: var(--text-sm); color: var(--gray-400); }

    /* ── Graph (Step 4) - unchanged ──────────────── */
    .graph-fullpage { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--gray-100); z-index: 200; display: flex; flex-direction: column; }
    .graph-topbar { background: var(--white); box-shadow: 0 1px 0 rgba(0,0,0,0.06); padding: 0 var(--sp-6); height: 52px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .graph-topbar-left { display: flex; align-items: center; gap: var(--sp-3); }
    .graph-topbar-back { display: flex; align-items: center; gap: var(--sp-1); font-size: var(--text-sm); font-weight: 500; color: var(--gray-500); background: none; border: none; cursor: pointer; padding: var(--sp-2) var(--sp-3); border-radius: var(--radius-sm); font-family: inherit; }
    .graph-topbar-back:hover { background: var(--gray-100); color: var(--gray-700); }
    .graph-topbar-back svg { width: 16px; height: 16px; }
    .graph-topbar-divider { width: 1px; height: 20px; background: var(--gray-200); }
    .graph-topbar-title { font-size: var(--text-md); font-weight: 600; color: var(--gray-900); }
    .graph-topbar-right { display: flex; align-items: center; gap: var(--sp-2); font-size: var(--text-xs); color: var(--gray-400); }
    .graph-tab-bar { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: 0 var(--sp-6); display: flex; align-items: center; gap: var(--sp-5); flex-shrink: 0; }
    .graph-tab { display: flex; align-items: center; gap: var(--sp-2); padding: var(--sp-3) 0; font-size: var(--text-sm); font-weight: 500; color: var(--gray-500); border-bottom: 2px solid transparent; cursor: pointer; margin-bottom: -1px; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
    .graph-tab:hover { color: var(--gray-700); }
    .graph-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .graph-tab svg { width: 16px; height: 16px; }
    .graph-toolbar { background: var(--white); border-bottom: 1px solid var(--gray-200); padding: var(--sp-2) var(--sp-6); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .graph-toolbar-left { display: flex; align-items: center; gap: var(--sp-3); }
    .graph-toolbar-label { font-size: var(--text-sm); color: var(--gray-600); display: flex; align-items: center; gap: var(--sp-2); }
    .graph-toolbar-label strong { font-weight: 600; color: var(--gray-900); }
    .graph-toolbar-notice { font-size: var(--text-sm); color: var(--warning-text); background: var(--warning-light); padding: var(--sp-1) var(--sp-3); border-radius: var(--radius-sm); }
    .graph-toolbar-right { display: flex; align-items: center; gap: var(--sp-2); }
    .graph-toolbar-center { display: flex; align-items: center; gap: var(--sp-1); }
    .mini-step { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--gray-400); }
    .mini-step-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; background: var(--gray-200); color: var(--gray-500); }
    .mini-step-dot.completed { background: var(--primary); color: white; }
    .mini-step-dot.active { background: var(--primary); color: white; box-shadow: 0 0 0 3px var(--primary-ring); }
    .mini-step-dot svg { width: 12px; height: 12px; }
    .mini-step-label { font-weight: 500; }
    .mini-step-label.completed, .mini-step-label.active { color: var(--primary); }
    .mini-step-line { width: 20px; height: 2px; background: var(--gray-200); border-radius: 1px; }
    .mini-step-line.completed { background: var(--primary); }
    .graph-toolbar-btn { font-family: inherit; font-size: var(--text-sm); font-weight: 500; padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid var(--gray-200); background: var(--white); color: var(--gray-600); cursor: pointer; display: flex; align-items: center; gap: var(--sp-2); }
    .graph-toolbar-btn:hover { border-color: var(--gray-300); color: var(--gray-700); }
    .graph-toolbar-btn svg { width: 14px; height: 14px; }
    .graph-toolbar-btn.primary { background: var(--primary); border-color: var(--primary); color: var(--white); }
    .graph-toolbar-btn.primary:hover { background: var(--primary-hover); }
    .graph-main { flex: 1; display: flex; position: relative; overflow: hidden; }
    .graph-canvas-wrapper { flex: 1; min-height: 0; position: relative; overflow: hidden; background: var(--gray-100); background-image: radial-gradient(circle, var(--gray-300) 1px, transparent 1px); background-size: 20px 20px; }
    .graph-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: grab; }
    .graph-canvas.grabbing { cursor: grabbing; }
    .graph-canvas-content { position: absolute; transform-origin: 0 0; }
    .graph-edges-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; }
    @keyframes edgeFlow { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
    .graph-edge-path { fill: none; stroke: rgba(16, 185, 129, 0.5); stroke-width: 2; stroke-dasharray: 8, 4; animation: edgeFlow 1s linear infinite; }
    .graph-node { position: absolute; background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); min-width: 180px; max-width: 220px; }
    .graph-node:hover { box-shadow: var(--shadow-md); }
    .graph-node.source { border-left: 3px solid #10b981; }
    .graph-node.process { border-left: 3px solid #0891b2; }
    .graph-node.output { border-left: 3px solid #ec4899; }
    .graph-node.emit { border-left: 3px solid #f59e0b; }
    .graph-node.purple { border-left: 3px solid #8b5cf6; }
    .graph-node.blue { border-left: 3px solid #3b82f6; }
    .graph-node.teal { border-left: 3px solid #14b8a6; }
    .graph-node-header { padding: var(--sp-2) var(--sp-3); border-bottom: 1px solid var(--gray-150); cursor: grab; }
    .graph-node-header:hover { background: var(--gray-50); }
    .graph-node-badge { display: inline-flex; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
    .graph-node-badge.source { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .graph-node-badge.process { background: #ecfeff; color: #0e7490; border: 1px solid #a5f3fc; }
    .graph-node-badge.output { background: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
    .graph-node-badge.emit { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
    .graph-node-badge.purple { background: #f5f3ff; color: #6d28d9; border: 1px solid #ddd6fe; }
    .graph-node-badge.blue { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
    .graph-node-badge.teal { background: #f0fdfa; color: #0f766e; border: 1px solid #99f6e4; }
    .graph-node-title { font-size: var(--text-sm); font-weight: 600; color: var(--gray-900); }
    .graph-node-body { padding: var(--sp-2) var(--sp-3); font-size: 10px; color: var(--gray-500); }
    .graph-node-stat { display: flex; align-items: center; gap: var(--sp-2); }
    .graph-node-stat strong { color: var(--gray-700); }
    .graph-zoom-controls { position: absolute; bottom: var(--sp-4); left: var(--sp-4); display: flex; flex-direction: column; gap: var(--sp-1); z-index: 50; }
    .graph-zoom-panel { background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-md); padding: var(--sp-1); display: flex; flex-direction: column; gap: 2px; }
    .graph-zoom-btn { width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--white); border: 1px solid var(--gray-200); color: var(--gray-600); cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: inherit; }
    .graph-zoom-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
    .graph-zoom-level { background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-md); padding: var(--sp-1) var(--sp-2); font-size: 11px; font-weight: 600; color: var(--gray-700); text-align: center; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useMemo, useRef, useEffect } = React;

/* ── Ant Design Components ────────────────────────── */
const { Button, Table, Tag, Input, Select, Steps, Collapse, Spin, Alert, Segmented, ConfigProvider, Space, Tooltip, theme } = antd;
const { SearchOutlined, CheckCircleOutlined, WarningOutlined, CloseOutlined, UploadOutlined, FileTextOutlined, SaveOutlined, PlusOutlined, LeftOutlined, RightOutlined, DatabaseOutlined, CloudOutlined, ThunderboltOutlined, HeartOutlined, ApiOutlined, ExperimentOutlined } = icons;

/* ── SVG Icons (custom, for graph and specialized uses) ── */
const ChevronLeft = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15,18 9,12 15,6"/></svg>;
const ChevronRight = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9,6 15,12 9,18"/></svg>;
const CheckSm = (p) => <svg {...p} width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20,6 9,17 4,12"/></svg>;
const CheckLg = () => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="20,6 9,17 4,12"/></svg>;
const UploadIc = () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
const FileIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>;
const XIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
const CheckCircleIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>;
const SparklesIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/><path d="M5 19l.5 1.5L7 21l-1.5.5L5 23l-.5-1.5L3 21l1.5-.5L5 19z"/></svg>;
const BrainIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 4.5a2.5 2.5 0 00-4.96-.46 2.5 2.5 0 00-1.98 3 2.5 2.5 0 00-1.32 4.24 3 3 0 00.34 5.58 2.5 2.5 0 002.96 3.08A2.5 2.5 0 0012 19.5a2.5 2.5 0 004.96.44 2.5 2.5 0 002.96-3.08 3 3 0 00.34-5.58 2.5 2.5 0 00-1.32-4.24 2.5 2.5 0 00-1.98-3A2.5 2.5 0 0012 4.5"/></svg>;
const SaveIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>;
const CodeIc = () => <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/></svg>;
const SearchIc = () => <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
const LayersIc = () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12,2 2,7 12,12 22,7 12,2"/><polyline points="2,17 12,22 22,17"/><polyline points="2,12 12,17 22,12"/></svg>;
const PlusIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const ServerIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>;
const CloudIcSvg = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/></svg>;
const ZapIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"/></svg>;
const ActivityIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>;
const DatabaseIcSvg = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
const ArrowRightSmIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12,5 19,12 12,19"/></svg>;

/* Graph icons */
const ZoomInIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>;
const ZoomOutIc = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>;
const ChevronLeftIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15,18 9,12 15,6"/></svg>;
const GraphTabIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="5" cy="6" r="2"/><circle cx="12" cy="4" r="2"/><circle cx="19" cy="8" r="2"/><circle cx="6" cy="18" r="2"/><circle cx="14" cy="16" r="2"/><line x1="7" y1="6" x2="10" y2="4.5"/><line x1="14" y1="4.5" x2="17" y2="7"/><line x1="6" y1="8" x2="6" y2="16"/><line x1="16" y1="16" x2="17" y2="8"/></svg>;
const FileOutputIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>;
const BookIc = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>;
const RefreshIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,4 23,10 17,10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>;
const SaveIc2 = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>;
const ZapGraphIc = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"/></svg>;

/* ── Connector Data ──────────────────────────────── */
const connectorCategories = [
  { id:'files', title:'File Import', iconClass:'files', icon: () => <UploadIc />, connectors:[] },
  { id:'database', title:'On-Prem Database', iconClass:'database', icon: () => <DatabaseIcSvg />,
    connectors:[{id:'eaglesoft',name:'Eaglesoft',desc:'Patterson on-prem PMS'},{id:'opendental',name:'OpenDental',desc:'Open-source dental PMS'},{id:'dentrix',name:'Dentrix',desc:'Henry Schein One PMS'},{id:'postgres',name:'PostgreSQL',desc:'Direct database connection'},{id:'mssql',name:'SQL Server',desc:'Microsoft SQL Server'},{id:'mysql',name:'MySQL',desc:'MySQL / MariaDB'}]},
  { id:'warehouse', title:'Data Warehouse', iconClass:'warehouse', icon: () => <ServerIc />,
    connectors:[{id:'snowflake',name:'Snowflake',desc:'Cloud data warehouse'},{id:'databricks',name:'Databricks',desc:'Lakehouse platform'},{id:'redshift',name:'AWS Redshift',desc:'Amazon managed warehouse'},{id:'bigquery',name:'BigQuery',desc:'Google Cloud warehouse'}]},
  { id:'cloud', title:'Cloud API / SaaS', iconClass:'api', icon: () => <CloudIcSvg />,
    connectors:[{id:'curvedental',name:'Curve Dental',desc:'Cloud-native dental PMS'},{id:'tab32',name:'tab32',desc:'Cloud dental platform'},{id:'denticon',name:'Denticon',desc:'Planet DDS cloud PMS'},{id:'restapi',name:'Custom REST API',desc:'Any REST / GraphQL endpoint'}]},
  { id:'ehr', title:'EHR System', iconClass:'ehr', icon: () => <ActivityIc />,
    connectors:[{id:'epic',name:'Epic Clarity',desc:'Epic data warehouse'},{id:'cerner',name:'Cerner',desc:'Oracle Health / Cerner'},{id:'fhir-endpoint',name:'FHIR Endpoint',desc:'Any FHIR R4 server'}]},
  { id:'stream', title:'Event Stream', iconClass:'stream', icon: () => <ZapIc />,
    connectors:[{id:'kafka',name:'Apache Kafka',desc:'Kafka topic subscription'},{id:'webhook',name:'Webhook Ingestion',desc:'HTTP webhook receiver'},{id:'s3',name:'AWS S3',desc:'S3 bucket listener'},{id:'gcs',name:'GCP Cloud Storage',desc:'GCS bucket listener'}]},
];

/* ── Options ────────────────────────────────────── */
const pmsOptions = [
  { value: 'OpenDental', label: 'OpenDental' },
  { value: 'Dentrix', label: 'Dentrix' },
  { value: 'Eaglesoft', label: 'Eaglesoft' },
  { value: 'Curve', label: 'Curve' },
  { value: 'Other', label: 'Other / Unknown' },
];
const standardOptions = [
  { value: 'fhir-r4', label: 'FHIR R4' },
  { value: 'fhir-r5', label: 'FHIR R5' },
  { value: 'hl7-v2', label: 'HL7 v2.x' },
  { value: 'x12-837', label: 'X12 837D' },
  { value: 'x12-270', label: 'X12 270/271' },
];
const vocabOptions = [
  { value: 'cdt', label: 'CDT (Dental Procedures)' },
  { value: 'snodent', label: 'SNODENT (Dental Terminology)' },
  { value: 'loinc', label: 'LOINC (Lab Observations)' },
  { value: 'snomed', label: 'SNOMED CT (Clinical Terms)' },
  { value: 'cpt', label: 'CPT (Medical Procedures)' },
  { value: 'icd10', label: 'ICD-10 (Diagnoses)' },
];

/* ── Classified file data ─────────────────────────
   UPDATED: ontology now uses vocabulary codes (CDT, SNODENT, LOINC, SNOMED, ICD-10)
   instead of output standards (FHIR). Fields without a vocab code use 'none'.
   ────────────────────────────────────────────────── */
const classifiedFiles = [
  {
    id: 'f1', fileName: 'patients_export.csv', format: 'CSV', shape: 'tabular',
    assignedRole: 'patients', confidence: 98, issues: 0,
    fields: [
      { id: 'p1', fieldName: 'patient_id', dataType: 'string', semanticLabel: 'Patient Identifier', ontology: 'snomed', ontologyCode: '116154003', confidence: 98, status: 'approved', sample: 'PAT-12345', relation: { type: 'pk', refs: ['encounters', 'procedures', 'claims'] } },
      { id: 'p2', fieldName: 'first_name', dataType: 'string', semanticLabel: 'Patient Given Name', ontology: 'snomed', ontologyCode: '184096005', confidence: 96, status: 'approved', sample: 'Sarah' },
      { id: 'p3', fieldName: 'last_name', dataType: 'string', semanticLabel: 'Patient Family Name', ontology: 'snomed', ontologyCode: '184095009', confidence: 97, status: 'approved', sample: 'Johnson' },
      { id: 'p4', fieldName: 'dob', dataType: 'date', semanticLabel: 'Date of Birth', ontology: 'snomed', ontologyCode: '184099003', confidence: 94, status: 'approved', sample: '1985-03-22' },
      { id: 'p5', fieldName: 'gender', dataType: 'string', semanticLabel: 'Administrative Gender', ontology: 'snomed', ontologyCode: '263495000', confidence: 91, status: 'approved', sample: 'female' },
      { id: 'p6', fieldName: 'ssn_last4', dataType: 'string', semanticLabel: 'Partial SSN', ontology: 'none', ontologyCode: null, confidence: 72, status: 'review', sample: '4589' },
      { id: 'p7', fieldName: 'zip_code', dataType: 'string', semanticLabel: 'Postal Code', ontology: 'snomed', ontologyCode: '184102003', confidence: 93, status: 'approved', sample: '90210' },
      { id: 'p8', fieldName: 'phone', dataType: 'string', semanticLabel: 'Contact Phone', ontology: 'snomed', ontologyCode: '184103008', confidence: 90, status: 'approved', sample: '555-0134' },
    ]
  },
  {
    id: 'f2', fileName: 'encounters_2024.csv', format: 'CSV', shape: 'tabular',
    assignedRole: 'encounters', confidence: 96, issues: 3,
    fields: [
      { id: 'e1', fieldName: 'visit_id', dataType: 'string', semanticLabel: 'Encounter Identifier', ontology: 'snomed', ontologyCode: '308335008', confidence: 96, status: 'approved', sample: 'VIS-8821', relation: { type: 'pk', refs: ['procedures', 'claims'] } },
      { id: 'e2', fieldName: 'visit_date', dataType: 'datetime', semanticLabel: 'Encounter Start', ontology: 'snomed', ontologyCode: '252131008', confidence: 93, status: 'approved', sample: '2024-01-15' },
      { id: 'e3', fieldName: 'provider_id', dataType: 'string', semanticLabel: 'Practitioner Reference', ontology: 'snodent', ontologyCode: '133927', confidence: 88, status: 'approved', sample: 'PRV-441', relation: { type: 'fk', ref: 'practitioners' } },
      { id: 'e4', fieldName: 'visit_type', dataType: 'string', semanticLabel: 'Encounter Type', ontology: 'snomed', ontologyCode: '185349003', confidence: 85, status: 'approved', sample: 'ROUTINE' },
      { id: 'e5', fieldName: 'location_cd', dataType: 'string', semanticLabel: 'Service Location', ontology: 'snodent', ontologyCode: '210070', confidence: 68, status: 'review', sample: 'LOC-3' },
      { id: 'e6', fieldName: 'status_flag', dataType: 'integer', semanticLabel: 'Unknown', ontology: 'none', ontologyCode: null, confidence: 35, status: 'abstained', sample: '1' },
    ]
  },
  {
    id: 'f3', fileName: 'procedures_jan.json', format: 'JSON', shape: 'object',
    assignedRole: 'procedures', confidence: 95, issues: 0,
    fields: [
      { id: 'pr1', fieldName: 'proc_cd', dataType: 'string', semanticLabel: 'Procedure Code', ontology: 'cdt', ontologyCode: 'D1110', confidence: 95, status: 'approved', sample: 'D1110' },
      { id: 'pr2', fieldName: 'proc_desc', dataType: 'string', semanticLabel: 'Procedure Description', ontology: 'cdt', ontologyCode: null, confidence: 90, status: 'approved', sample: 'Prophylaxis – Adult' },
      { id: 'pr3', fieldName: 'tooth_num', dataType: 'integer', semanticLabel: 'Tooth Number', ontology: 'snodent', ontologyCode: '135646', confidence: 87, status: 'approved', sample: '14' },
      { id: 'pr4', fieldName: 'surface', dataType: 'string', semanticLabel: 'Tooth Surface', ontology: 'snodent', ontologyCode: '135782', confidence: 82, status: 'review', sample: 'MOD' },
      { id: 'pr5', fieldName: 'proc_fee', dataType: 'decimal', semanticLabel: 'Procedure Fee', ontology: 'cpt', ontologyCode: null, confidence: 78, status: 'review', sample: '185.00' },
      { id: 'pr6', fieldName: 'proc_date', dataType: 'date', semanticLabel: 'Procedure Date', ontology: 'snomed', ontologyCode: '399651003', confidence: 92, status: 'approved', sample: '2024-01-15' },
      { id: 'pr7', fieldName: 'dx_code', dataType: 'string', semanticLabel: 'Diagnosis Code', ontology: 'icd10', ontologyCode: 'K02.9', confidence: 89, status: 'approved', sample: 'K02.9' },
    ]
  },
  {
    id: 'f4', fileName: 'claims_q1.csv', format: 'CSV', shape: 'tabular',
    assignedRole: 'claims', confidence: 100, issues: 0,
    fields: [
      { id: 'c1', fieldName: 'claim_id', dataType: 'string', semanticLabel: 'Claim Identifier', ontology: 'snomed', ontologyCode: '900000000000003001', confidence: 97, status: 'approved', sample: 'CLM-19923' },
      { id: 'c2', fieldName: 'payer_id', dataType: 'string', semanticLabel: 'Insurer Reference', ontology: 'snomed', ontologyCode: '32485007', confidence: 91, status: 'approved', sample: 'INS-Delta', relation: { type: 'fk', ref: 'payers' } },
      { id: 'c3', fieldName: 'claim_status', dataType: 'string', semanticLabel: 'Claim Status', ontology: 'snomed', ontologyCode: '263490005', confidence: 89, status: 'approved', sample: 'active' },
      { id: 'c4', fieldName: 'billed_amt', dataType: 'decimal', semanticLabel: 'Total Billed', ontology: 'cpt', ontologyCode: null, confidence: 86, status: 'approved', sample: '450.00' },
    ]
  },
  {
    id: 'f5', fileName: 'lab_results.json', format: 'JSON', shape: 'object',
    assignedRole: 'observations', confidence: 88, issues: 2,
    fields: [
      { id: 'o1', fieldName: 'lab_code', dataType: 'string', semanticLabel: 'Observation Code', ontology: 'loinc', ontologyCode: '2339-0', confidence: 88, status: 'approved', sample: '2339-0' },
      { id: 'o2', fieldName: 'lab_result', dataType: 'decimal', semanticLabel: 'Observation Value', ontology: 'loinc', ontologyCode: '2339-0', confidence: 75, status: 'review', sample: '92' },
      { id: 'o3', fieldName: 'lab_unit', dataType: 'string', semanticLabel: 'Value Unit', ontology: 'snomed', ontologyCode: '258795003', confidence: 70, status: 'review', sample: 'mg/dL' },
      { id: 'o4', fieldName: 'collected_dt', dataType: 'datetime', semanticLabel: 'Collection Date', ontology: 'loinc', ontologyCode: '33882-2', confidence: 91, status: 'approved', sample: '2024-01-10' },
    ]
  },
];

/* ── Helpers ──────────────────────────────────────── */
const confLevel = (c) => c >= 85 ? 'high' : c >= 65 ? 'medium' : 'low';
const confColor = (c) => c >= 85 ? '#10b981' : c >= 65 ? '#f59e0b' : '#ef4444';
const allFields = (files) => files.flatMap(f => f.fields);

/* Code system display colors */
const codeSystemColors = {
  cdt: { color: '#0e7490', bg: '#ecfeff', border: '#a5f3fc' },
  snodent: { color: '#7c3aed', bg: '#f5f3ff', border: '#ddd6fe' },
  loinc: { color: '#d97706', bg: '#fffbeb', border: '#fde68a' },
  snomed: { color: '#059669', bg: '#f0fdf4', border: '#a7f3d0' },
  icd10: { color: '#dc2626', bg: '#fef2f2', border: '#fecaca' },
  cpt: { color: '#2563eb', bg: '#eff6ff', border: '#bfdbfe' },
};

/* ═══════════════════════════════════════════════════
   Graph View Step Component (unchanged)
   ═══════════════════════════════════════════════════ */
function GraphViewStep({ files, fields, onBack, onContinue }) {
  const [viewport, setViewport] = useState({ x: 40, y: 20, zoom: 0.85 });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });
  const [activeTab, setActiveTab] = useState('graph');
  const canvasRef = useRef(null);

  const sourceNodes = files.map((f, i) => ({ id: f.id, type: 'source', name: f.fileName, badge: 'Source', x: 40, y: 40 + i * 140, fields: f.fields.length, confidence: f.confidence }));
  const processNodes = [
    { id: 'p1', type: 'process', name: 'Ontology Binding', badge: 'Ontology', color: 'blue', x: 300, y: 50 },
    { id: 'p2', type: 'process', name: 'Validation', badge: 'Validate', color: 'process', x: 300, y: 160 },
    { id: 'p3', type: 'process', name: 'Enrichment', badge: 'Enrich', color: 'purple', x: 300, y: 270 },
    { id: 'p4', type: 'process', name: 'Mapping', badge: 'Map', color: 'teal', x: 300, y: 380 },
  ];
  const emitNode = { id: 'emit', type: 'emit', name: 'Emit Outputs', badge: 'Emit', x: 540, y: 215 };
  const outputNodes = [
    { id: 'o1', type: 'output', name: 'Patient', badge: 'FHIR', x: 760, y: 40 },
    { id: 'o2', type: 'output', name: 'Encounter', badge: 'FHIR', x: 760, y: 160 },
    { id: 'o3', type: 'output', name: 'Procedure', badge: 'CDT', x: 760, y: 280 },
    { id: 'o4', type: 'output', name: 'Claim', badge: 'FHIR', x: 760, y: 400 },
    { id: 'o5', type: 'output', name: 'Audit Trail', badge: 'Internal', x: 760, y: 520 },
  ];

  const edges = [];
  sourceNodes.forEach(src => { edges.push({ from: { x: src.x + 180, y: src.y + 50 }, to: { x: processNodes[0].x, y: processNodes[0].y + 40 } }); });
  processNodes.forEach((p, i) => { if (i < processNodes.length - 1) edges.push({ from: { x: p.x + 90, y: p.y + 80 }, to: { x: processNodes[i+1].x + 90, y: processNodes[i+1].y } }); });
  edges.push({ from: { x: processNodes[2].x + 180, y: processNodes[2].y + 40 }, to: { x: emitNode.x, y: emitNode.y + 50 } });
  outputNodes.forEach(out => { edges.push({ from: { x: emitNode.x + 180, y: emitNode.y + 50 }, to: { x: out.x, y: out.y + 50 } }); });

  const handleMouseDown = (e) => { if (e.target === canvasRef.current || e.target.classList.contains('graph-canvas-content')) { setIsPanning(true); setPanStart({ x: e.clientX - viewport.x, y: e.clientY - viewport.y }); } };
  const handleMouseMove = (e) => { if (isPanning) setViewport(v => ({ ...v, x: e.clientX - panStart.x, y: e.clientY - panStart.y })); };
  const handleMouseUp = () => setIsPanning(false);
  const handleWheel = (e) => { e.preventDefault(); const delta = e.deltaY > 0 ? 0.9 : 1.1; setViewport(v => ({ ...v, zoom: Math.min(Math.max(v.zoom * delta, 0.3), 2) })); };

  return (
    <div className="graph-fullpage">
      <div className="graph-topbar">
        <div className="graph-topbar-left">
          <button className="graph-topbar-back" onClick={onBack}><ChevronLeftIc /> Back to Wizard</button>
          <div className="graph-topbar-divider" />
          <span className="graph-topbar-title">Graph Editor</span>
        </div>
        <div className="graph-topbar-right">HeyDonto</div>
      </div>
      <div className="graph-tab-bar">
        <button className={`graph-tab ${activeTab === 'graph' ? 'active' : ''}`} onClick={() => setActiveTab('graph')}><GraphTabIc /> Graph Editor</button>
        <button className={`graph-tab ${activeTab === 'output' ? 'active' : ''}`} onClick={() => setActiveTab('output')}><FileOutputIc /> Compile Output</button>
        <button className={`graph-tab ${activeTab === 'docs' ? 'active' : ''}`} onClick={() => setActiveTab('docs')}><BookIc /> Guidelines</button>
      </div>
      <div className="graph-toolbar">
        <div className="graph-toolbar-left">
          <span className="graph-toolbar-label">Graph schema: <strong>1.0</strong></span>
          <span className="graph-toolbar-notice">Using default template – Save to persist</span>
        </div>
        <div className="graph-toolbar-center">
          {['Upload','Classify','Configure'].map((l,i) => (<React.Fragment key={l}><div className="mini-step"><span className="mini-step-dot completed"><CheckSm /></span><span className="mini-step-label completed">{l}</span></div><div className="mini-step-line completed" /></React.Fragment>))}
          <div className="mini-step"><span className="mini-step-dot active">4</span><span className="mini-step-label active">Graph</span></div>
          {['Generate','Save'].map((l,i) => (<React.Fragment key={l}><div className="mini-step-line" /><div className="mini-step"><span className="mini-step-dot">{5+i}</span><span className="mini-step-label">{l}</span></div></React.Fragment>))}
        </div>
        <div className="graph-toolbar-right">
          <button className="graph-toolbar-btn"><RefreshIc /> Reset</button>
          <button className="graph-toolbar-btn"><SaveIc2 /> Save</button>
          <button className="graph-toolbar-btn primary"><ZapGraphIc /> Save & Compile</button>
          <div style={{ width: '1px', height: '24px', background: 'var(--gray-200)', margin: '0 8px' }} />
          <button className="graph-toolbar-btn primary" onClick={onContinue}>Continue →</button>
        </div>
      </div>
      <div className="graph-main">
        <div className="graph-canvas-wrapper" ref={canvasRef} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onWheel={handleWheel}>
          <div className="graph-canvas-content" style={{ transform: `translate(${viewport.x}px, ${viewport.y}px) scale(${viewport.zoom})` }}>
            <svg className="graph-edges-svg" style={{ width: 1000, height: 700 }}>
              {edges.map((edge, i) => { const midX = (edge.from.x + edge.to.x) / 2; return <path key={i} className="graph-edge-path" d={`M ${edge.from.x} ${edge.from.y} C ${midX} ${edge.from.y}, ${midX} ${edge.to.y}, ${edge.to.x} ${edge.to.y}`} />; })}
            </svg>
            {sourceNodes.map(n => (<div key={n.id} className="graph-node source" style={{ left: n.x, top: n.y }}><div className="graph-node-header"><div className="graph-node-badge source">{n.badge}</div><div className="graph-node-title">{n.name}</div></div><div className="graph-node-body"><div className="graph-node-stat"><strong>{n.fields}</strong> fields · {n.confidence}% conf</div></div></div>))}
            {processNodes.map(n => (<div key={n.id} className={`graph-node ${n.color}`} style={{ left: n.x, top: n.y }}><div className="graph-node-header"><div className={`graph-node-badge ${n.color}`}>{n.badge}</div><div className="graph-node-title">{n.name}</div></div><div className="graph-node-body"><div className="graph-node-stat">{fields.length} → {fields.filter(f => f.status === 'approved').length}</div></div></div>))}
            <div className="graph-node emit" style={{ left: emitNode.x, top: emitNode.y }}><div className="graph-node-header"><div className="graph-node-badge emit">{emitNode.badge}</div><div className="graph-node-title">{emitNode.name}</div></div><div className="graph-node-body"><div className="graph-node-stat">{fields.filter(f => f.status === 'approved').length} → {outputNodes.length} resources</div></div></div>
            {outputNodes.map(n => (<div key={n.id} className="graph-node output" style={{ left: n.x, top: n.y }}><div className="graph-node-header"><div className="graph-node-badge output">{n.badge}</div><div className="graph-node-title">{n.name}</div></div><div className="graph-node-body"><div className="graph-node-stat">FHIR R4</div></div></div>))}
          </div>
          <div className="graph-zoom-controls">
            <div className="graph-zoom-panel">
              <button className="graph-zoom-btn" onClick={() => setViewport(v => ({ ...v, zoom: Math.min(v.zoom * 1.2, 2) }))}><ZoomInIc /></button>
              <button className="graph-zoom-btn" onClick={() => setViewport(v => ({ ...v, zoom: Math.max(v.zoom * 0.8, 0.3) }))}><ZoomOutIc /></button>
            </div>
            <div className="graph-zoom-level">{Math.round(viewport.zoom * 100)}%</div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════════
   App
   ═══════════════════════════════════════════════════ */
function App() {
  const [step, setStep] = useState(1);
  const [highestStep, setHighestStep] = useState(1);

  // Step 1
  const [files, setFiles] = useState([]);
  const [detectedPms, setDetectedPms] = useState('');
  const [sources, setSources] = useState([]);
  const [pickerState, setPickerState] = useState('closed');

  // Step 2
  const [classifying, setClassifying] = useState(false);
  const [classified, setClassified] = useState(false);
  const [cFiles, setCFiles] = useState([]);
  const [expandedKeys, setExpandedKeys] = useState([]);
  const [showAllFields, setShowAllFields] = useState({});
  const [schemaView, setSchemaView] = useState({});
  const [statusFilter, setStatusFilter] = useState('all');
  const [search, setSearch] = useState('');

  // Step 3
  const [standard, setStandard] = useState('');
  const [vocab, setVocab] = useState('');

  // Step 5
  const [generating, setGenerating] = useState(false);
  const [generated, setGenerated] = useState(false);

  // Step 6
  const [profileName, setProfileName] = useState('');

  const goStep = (n) => { if (n <= highestStep) setStep(n); };
  const handleNext = () => {
    const next = step + 1;
    if (step === 1) { setStep(2); setHighestStep(h => Math.max(h, 2)); runClassification(); }
    else if (step === 5 && !generated) return;
    else if (next <= 6) { setStep(next); setHighestStep(h => Math.max(h, next)); }
  };
  const handleBack = () => { if (step > 1) setStep(step - 1); };

  /* Step 1 */
  const demoFiles = [
    { name: 'patients_export.csv', size: '2.4 MB', type: 'csv' },
    { name: 'encounters_2024.csv', size: '5.1 MB', type: 'csv' },
    { name: 'procedures_jan.json', size: '1.8 MB', type: 'json' },
    { name: 'claims_q1.csv', size: '892 KB', type: 'csv' },
    { name: 'lab_results.json', size: '3.2 MB', type: 'json' },
  ];
  const addFile = () => { const next = demoFiles[files.length % demoFiles.length]; setFiles(f => [...f, { id: Date.now(), ...next }]); if (!detectedPms) setDetectedPms('OpenDental'); };
  const removeFile = (id) => { const nf = files.filter(f => f.id !== id); setFiles(nf); if (!nf.length) setDetectedPms(''); };
  const addSource = (catId, conn) => { const cat = connectorCategories.find(c => c.id === catId); setSources(s => [...s, { id: Date.now().toString(), connectorId: conn.id, name: conn.name, desc: conn.desc, category: catId, categoryTitle: cat.title, iconClass: cat.iconClass }]); setPickerState('closed'); };
  const removeSource = (id) => setSources(s => s.filter(x => x.id !== id));
  const categoryDescriptions = { files: 'Drag & drop CSV, JSON, Excel, PDF, HL7 files', database: 'Eaglesoft, OpenDental, Dentrix, SQL', warehouse: 'Snowflake, Databricks, Redshift, BigQuery', cloud: 'Curve, tab32, Denticon, REST API', ehr: 'Epic, Cerner, FHIR endpoints', stream: 'Kafka, Webhooks, S3, GCS' };

  /* Step 2 */
  const runClassification = () => { setClassifying(true); setTimeout(() => { setClassifying(false); setClassified(true); setCFiles(JSON.parse(JSON.stringify(classifiedFiles))); }, 2000); };
  const toggleShowAll = (id) => setShowAllFields(s => ({ ...s, [id]: !s[id] }));
  const toggleSchemaView = (id) => setSchemaView(s => ({ ...s, [id]: !s[id] }));

  const generateSchema = (file) => {
    const properties = {};
    file.fields.forEach(f => {
      const prop = { type: f.dataType, semantic: f.semanticLabel };
      if (f.ontologyCode) prop.binding = { system: f.ontology.toUpperCase(), code: f.ontologyCode };
      properties[f.fieldName] = prop;
    });
    return { $schema: 'https://heydonto.com/schemas/classified-object/v1', role: file.assignedRole, source: file.fileName, format: file.format.toLowerCase(), shape: file.shape, fieldCount: file.fields.length, properties };
  };

  const renderJson = (obj, indent = 0) => {
    const pad1 = '  '.repeat(indent + 1);
    const entries = Object.entries(obj);
    const lines = [];
    lines.push(<span key="open" className="json-bracket">{'{'}</span>);
    entries.forEach(([key, val], i) => {
      const comma = i < entries.length - 1 ? ',' : '';
      if (val === null) { lines.push(<div key={key}>{pad1}<span className="json-key">"{key}"</span>: <span className="json-type">null</span>{comma}</div>); }
      else if (typeof val === 'object' && !Array.isArray(val)) {
        lines.push(<div key={key + '_open'}>{pad1}<span className="json-key">"{key}"</span>: <span className="json-bracket">{'{'}</span></div>);
        Object.entries(val).forEach(([k2, v2], j, arr) => {
          const c2 = j < arr.length - 1 ? ',' : '';
          if (typeof v2 === 'object' && v2 !== null) {
            const inner = Object.entries(v2).map(([k3, v3], m, a3) => `"${k3}": "${v3}"${m < a3.length - 1 ? ', ' : ''}`).join('');
            lines.push(<div key={key + k2}>{pad1}{'  '}<span className="json-key">"{k2}"</span>: <span className="json-bracket">{'{ '}</span>{inner}<span className="json-bracket">{' }'}</span>{c2}</div>);
          } else {
            const isNum = typeof v2 === 'number';
            lines.push(<div key={key + k2}>{pad1}{'  '}<span className="json-key">"{k2}"</span>: <span className={isNum ? 'json-type' : 'json-string'}>"{v2}"</span>{c2}</div>);
          }
        });
        lines.push(<div key={key + '_close'}>{pad1}<span className="json-bracket">{'}'}</span>{comma}</div>);
      } else if (typeof val === 'number') { lines.push(<div key={key}>{pad1}<span className="json-key">"{key}"</span>: <span className="json-type">{val}</span>{comma}</div>); }
      else { lines.push(<div key={key}>{pad1}<span className="json-key">"{key}"</span>: <span className="json-string">"{val}"</span>{comma}</div>); }
    });
    lines.push(<span key="close" className="json-bracket">{'}'}</span>);
    return lines;
  };

  const flat = useMemo(() => allFields(cFiles), [cFiles]);
  const reviewCount = flat.filter(f => f.status === 'review').length;
  const totalIssues = cFiles.reduce((s, f) => s + f.issues, 0);

  const filteredFiles = useMemo(() => {
    let fls = cFiles;
    if (statusFilter !== 'all') fls = fls.map(f => ({ ...f, fields: f.fields.filter(fd => fd.status === statusFilter) })).filter(f => f.fields.length > 0);
    if (search.trim()) {
      const q = search.toLowerCase();
      fls = fls.map(f => {
        const fileMatch = f.fileName.toLowerCase().includes(q) || f.assignedRole.toLowerCase().includes(q);
        if (fileMatch) return f;
        const matchingFields = f.fields.filter(fd => fd.fieldName.toLowerCase().includes(q) || fd.semanticLabel.toLowerCase().includes(q) || (fd.ontologyCode && fd.ontologyCode.toLowerCase().includes(q)) || (fd.ontology && fd.ontology.toLowerCase().includes(q)));
        return matchingFields.length ? { ...f, fields: matchingFields } : null;
      }).filter(Boolean);
    }
    return fls;
  }, [cFiles, statusFilter, search]);

  const filteredFieldCount = filteredFiles.reduce((s, f) => s + f.fields.length, 0);
  const isFiltered = statusFilter !== 'all' || search.trim();
  const clearAllFilters = () => { setStatusFilter('all'); setSearch(''); };

  const handleGenerate = () => { setGenerating(true); setTimeout(() => { setGenerating(false); setGenerated(true); setProfileName(`${detectedPms} → ${standardOptions.find(s => s.value === standard)?.label || ''}`); }, 1800); };

  const canNext = () => {
    if (step === 1) return (files.length > 0 && detectedPms) || sources.length > 0;
    if (step === 2) return classified && !classifying;
    if (step === 3) return standard && vocab;
    if (step === 4) return true;
    if (step === 5) return generated;
    return false;
  };

  const stepsConfig = [
    { num: 1, label: 'Sources' }, { num: 2, label: 'Classify' },
    { num: 3, label: 'Configure' }, { num: 4, label: 'Graph' },
    { num: 5, label: 'Generate' }, { num: 6, label: 'Save' },
  ];

  const getVisibleFields = (file) => {
    if (showAllFields[file.id]) {
      const needs = file.fields.filter(f => f.status === 'review' || f.status === 'abstained');
      return needs.length > 0 ? needs : file.fields;
    }
    return file.fields;
  };

  /* ── Ant Design Table columns for Step 2 ──────────
     CHANGE 1: Semantic Meaning is now before Type
     CHANGE 2: Code System shows vocab (CDT, SNODENT, etc.) not FHIR
     ─────────────────────────────────────────────────── */
  const getFieldColumns = () => [
    {
      title: 'Field',
      dataIndex: 'fieldName',
      key: 'fieldName',
      width: 200,
      render: (text, fd) => (
        <span>
          <span className="field-name">{text}</span>
          {fd.relation && fd.relation.type === 'pk' && (
            <Tooltip title={`Referenced by: ${fd.relation.refs.join(', ')}`}>
              <span className="relation-badge pk">PK · {fd.relation.refs.length} refs</span>
            </Tooltip>
          )}
          {fd.relation && fd.relation.type === 'fk' && (
            <Tooltip title={`Foreign key → ${fd.relation.ref}`}>
              <span className="relation-badge fk">→ {fd.relation.ref}</span>
            </Tooltip>
          )}
        </span>
      ),
    },
    {
      title: '',
      key: 'arrow',
      width: 32,
      render: () => <span style={{ color: 'var(--gray-300)', fontSize: 16, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>→</span>,
    },
    {
      title: 'Semantic Meaning',
      dataIndex: 'semanticLabel',
      key: 'semanticLabel',
      width: 200,
      render: (text) => <span className="semantic-label">{text}</span>,
    },
    {
      title: 'Type',
      dataIndex: 'dataType',
      key: 'dataType',
      width: 80,
      render: (text) => <span className="type-badge">{text}</span>,
    },
    {
      title: 'Code System',
      dataIndex: 'ontology',
      key: 'ontology',
      width: 100,
      render: (text) => {
        if (text === 'none') return <Tag style={{ fontSize: 10, fontWeight: 600, color: 'var(--gray-400)', background: 'var(--gray-50)', border: '1px dashed var(--gray-300)' }}>—</Tag>;
        const cs = codeSystemColors[text] || { color: 'var(--gray-600)', bg: 'var(--gray-100)', border: 'var(--gray-200)' };
        return <Tag style={{ fontSize: 10, fontWeight: 600, color: cs.color, background: cs.bg, border: `1px solid ${cs.border}`, textTransform: 'uppercase' }}>{text}</Tag>;
      },
    },
    {
      title: 'Example',
      dataIndex: 'sample',
      key: 'sample',
      width: 120,
      render: (text) => <span className="sample-chip" title={text}>{text}</span>,
    },

    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      width: 110,
      render: (text) => {
        if (text === 'approved') return <Tag color="success" style={{ fontSize: 'var(--text-xs)', fontWeight: 500 }}>✓ Approved</Tag>;
        if (text === 'review') return <Tag color="warning" style={{ fontSize: 'var(--text-xs)', fontWeight: 500 }}>⚠ Review</Tag>;
        return <Tag style={{ fontSize: 'var(--text-xs)', fontWeight: 500, color: 'var(--gray-500)' }}>— Abstained</Tag>;
      },
    },
  ];

  /* ── Build collapse items for Step 2 ───────────── */
  const collapseItems = filteredFiles.map(file => {
    const approved = file.fields.filter(f => f.status === 'approved').length;
    const total = file.fields.length;
    const visibleFields = getVisibleFields(file);
    const needsAttentionCount = file.fields.filter(f => f.status !== 'approved').length;
    const confLvl = confLevel(file.confidence);

    const label = (
      <div className="file-panel-header">
        <div className={`file-row-icon ${file.format.toLowerCase()}`}><FileIc /></div>
        <div className="file-row-name">{file.fileName} <span className="file-row-field-count">{total} fields</span></div>
        <div className="file-row-col"><Tag color="blue" style={{ fontSize: 'var(--text-xs)', fontWeight: 600 }}>{file.assignedRole}</Tag></div>
        <div className="file-row-col"><Tag style={{ fontSize: 10, fontWeight: 600, color: 'var(--gray-500)', background: 'var(--gray-150)', border: 'none', textTransform: 'uppercase' }}>{file.format}</Tag></div>
        <div className="file-row-col"><span className="shape-tag">{file.shape}</span></div>
        <div className="file-row-col">
          {file.issues === 0
            ? <Tag color="success" style={{ fontSize: 'var(--text-xs)', fontWeight: 600 }}>Clean</Tag>
            : <Tag color="warning" style={{ fontSize: 'var(--text-xs)', fontWeight: 600 }}>⚠ {file.issues}</Tag>
          }
        </div>
      </div>
    );

    const children = (
      <div className="file-row-body-inner">
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
          <div className="file-meta-pills" style={{ marginBottom: 0 }}>
            <span className="meta-pill">ID: {file.id}</span>
            <span className="meta-pill">Format: {file.format.toLowerCase()}</span>
            <span className="meta-pill">Shape: {file.shape}</span>
            <span className="meta-pill">{total} fields · {approved} approved</span>
          </div>
          <Segmented
            size="small"
            value={schemaView[file.id] ? 'schema' : 'fields'}
            onChange={(val) => toggleSchemaView(file.id)}
            options={[
              { label: 'Fields', value: 'fields' },
              { label: <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}><CodeIc /> Schema</span>, value: 'schema' },
            ]}
          />
        </div>

        {schemaView[file.id] ? (
          <div>
            <div className="schema-label">Inferred Object Schema</div>
            <pre className="schema-viewer">{renderJson(generateSchema(file))}</pre>
          </div>
        ) : (
          <Table
            columns={getFieldColumns()}
            dataSource={visibleFields}
            rowKey="id"
            size="small"
            pagination={false}
            rowClassName={(record) => record.status !== 'approved' ? 'needs-attention' : ''}
          />
        )}

        <div className="file-row-footer">
          <div>
            {!schemaView[file.id] && !showAllFields[file.id] && needsAttentionCount > 0 && needsAttentionCount < total && (
              <Button type="link" size="small" style={{ fontSize: 'var(--text-xs)', padding: 'var(--sp-1)' }} onClick={() => toggleShowAll(file.id)}>Show only {needsAttentionCount} fields needing review</Button>
            )}
            {!schemaView[file.id] && showAllFields[file.id] && (
              <Button type="link" size="small" style={{ fontSize: 'var(--text-xs)', padding: 'var(--sp-1)' }} onClick={() => toggleShowAll(file.id)}>Show all {total} fields</Button>
            )}
          </div>
        </div>
      </div>
    );

    return { key: file.id, label, children };
  });

  return (
    <ConfigProvider theme={{
      token: { colorPrimary: '#0891b2', fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif", borderRadius: 8, colorSuccess: '#10b981', colorWarning: '#f59e0b', colorError: '#ef4444' },
    }}>
    <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
      {/* Top bar */}
      <div className="topbar">
        <div className="topbar-left">
          <Button type="text" icon={<LeftOutlined />} style={{ color: 'var(--gray-500)', fontWeight: 500 }}>Mapping Profiles</Button>
          <div className="topbar-divider" />
          <span className="topbar-title">New Mapping Profile</span>
        </div>
        <div className="topbar-right">
          <span className="draft-indicator"><span className="draft-dot" /> Draft</span>
          <Button size="small" icon={<SaveOutlined />}>Save Draft</Button>
        </div>
      </div>

      {/* Stepper */}
      <div className="stepper-bar-wrap">
        <Steps
          size="small"
          current={step - 1}
          onChange={(n) => { if (n + 1 <= highestStep) goStep(n + 1); }}
          items={stepsConfig.map(s => ({ title: s.label }))}
        />
      </div>

      <div style={{ flex: 1 }} key={step} className="step-content">
        {/* ═══ Step 1 ═══ */}
        {step === 1 && (
          <div className="page-body narrow" style={{ maxWidth: 760 }}>
            <div className="section-heading">Connect Sources</div>
            <div className="section-sub">Add data sources for this mapping profile. Files, databases, warehouses, APIs, and more.</div>

            {sources.length === 0 && files.length === 0 && pickerState === 'closed' && (
              <div className="empty-hero"><div className="empty-hero-sub">Click the button below to add a source.</div></div>
            )}

            {(sources.length > 0 || (files.length > 0 && pickerState !== 'files')) && (
              <div className="sources-grid" style={{ marginBottom: 'var(--sp-4)' }}>
                {files.length > 0 && pickerState !== 'files' && (
                  <div className="source-card" style={{ cursor: 'pointer' }} onClick={() => setPickerState('files')}>
                    <div className="source-card-icon files"><UploadIc /></div>
                    <div className="source-card-info">
                      <div className="source-card-name">File Import</div>
                      <div className="source-card-meta">
                        <span className="source-card-tag connected">{files.length} file{files.length !== 1 ? 's' : ''} uploaded</span>
                        {detectedPms && <span>Detected: {detectedPms}</span>}
                      </div>
                    </div>
                    <Button type="text" size="small" icon={<CloseOutlined />} onClick={e => { e.stopPropagation(); setFiles([]); setDetectedPms(''); }} style={{ color: 'var(--gray-400)' }} danger />
                  </div>
                )}
                {sources.map(s => {
                  const cat = connectorCategories.find(c => c.id === s.category);
                  const CatIcon = cat ? cat.icon : () => null;
                  return (
                    <div key={s.id} className="source-card">
                      <div className={`source-card-icon ${s.iconClass}`}><CatIcon /></div>
                      <div className="source-card-info">
                        <div className="source-card-name">{s.name}</div>
                        <div className="source-card-meta"><span className="source-card-tag">{s.categoryTitle}</span><span className="source-card-tag connected">Connected</span></div>
                      </div>
                      <Button type="text" size="small" icon={<CloseOutlined />} onClick={() => removeSource(s.id)} style={{ color: 'var(--gray-400)' }} danger />
                    </div>
                  );
                })}
              </div>
            )}

            {pickerState === 'closed' && (
              <div style={{ display: 'flex', justifyContent: 'center', marginTop: (sources.length > 0 || files.length > 0) ? 0 : 'var(--sp-3)' }}>
                <Button type="dashed" size="large" icon={<PlusOutlined />} onClick={() => setPickerState('categories')} style={{ maxWidth: 280, width: '100%', height: 56 }}>Add Source</Button>
              </div>
            )}

            {pickerState === 'categories' && (
              <div className="category-list">
                {connectorCategories.map(cat => { const CatIcon = cat.icon; return (
                  <button key={cat.id} className="category-item" onClick={() => setPickerState(cat.id)}>
                    <div className={`category-item-icon source-card-icon ${cat.iconClass}`}><CatIcon /></div>
                    <div className="category-item-info"><div className="category-item-name">{cat.title}</div><div className="category-item-desc">{categoryDescriptions[cat.id]}</div></div>
                    {cat.connectors.length > 0 && <span className="category-item-count">{cat.connectors.length}</span>}
                    <span className="category-item-chevron"><ChevronRight /></span>
                  </button>
                ); })}
                <div style={{ display: 'flex', justifyContent: 'center', marginTop: 'var(--sp-2)' }}><Button type="text" icon={<CloseOutlined />} onClick={() => setPickerState('closed')}>Cancel</Button></div>
              </div>
            )}

            {pickerState === 'files' && (
              <div className="category-list">
                <Button type="text" icon={<LeftOutlined />} onClick={() => setPickerState(files.length > 0 ? 'closed' : 'categories')}>{files.length > 0 ? 'Done' : 'All integrations'}</Button>
                <div className="upload-zone" onClick={addFile}>
                  <div className="upload-icon"><UploadIc /></div>
                  <div className="upload-title">Drop files here or click to browse</div>
                  <div className="upload-sub">Upload sample exports from your practice management system</div>
                  <div className="upload-formats">Supports CSV, JSON, XLSX, PDF, HL7</div>
                </div>
                {files.length > 0 && (
                  <>
                    <div className="file-list">
                      <div className="file-list-title">Uploaded Files</div>
                      {files.map(f => (
                        <div key={f.id} className="file-item">
                          <div className={`file-icon-sm ${f.type}`}><FileIc /></div>
                          <div className="file-info"><div className="file-name">{f.name}</div><div className="file-size">{f.size}</div></div>
                          <Button type="text" size="small" icon={<CloseOutlined />} onClick={e => { e.stopPropagation(); removeFile(f.id); }} style={{ color: 'var(--gray-400)' }} danger />
                        </div>
                      ))}
                    </div>
                    <div className="detected-source">
                      <div className="detected-left"><CheckCircleIc /><span className="detected-label">Detected source:</span><span className="detected-value">{detectedPms}</span></div>
                      <Select size="small" value={detectedPms} onChange={val => setDetectedPms(val)} style={{ minWidth: 140 }} options={pmsOptions} />
                    </div>
                  </>
                )}
              </div>
            )}

            {pickerState !== 'closed' && pickerState !== 'categories' && pickerState !== 'files' && (() => {
              const cat = connectorCategories.find(c => c.id === pickerState);
              if (!cat) return null;
              const CatIcon = cat.icon;
              const dotColors = { database: '#2563eb', warehouse: '#d97706', cloud: '#db2777', ehr: '#0891b2', stream: '#7c3aed' };
              return (
                <div className="category-list">
                  <Button type="text" icon={<LeftOutlined />} onClick={() => setPickerState('categories')}>All integrations</Button>
                  <div className="category-item expanded" style={{ cursor: 'default' }}><div className={`category-item-icon source-card-icon ${cat.iconClass}`}><CatIcon /></div><div className="category-item-info"><div className="category-item-name">{cat.title}</div><div className="category-item-desc">{categoryDescriptions[cat.id]}</div></div></div>
                  <div className="connector-sub"><div className="connector-sub-inner">
                    {cat.connectors.map(c => (<button key={c.id} className="connector-sub-item" onClick={() => addSource(cat.id, c)}><span className="connector-sub-item-dot" style={{ background: dotColors[cat.id] || '#6b7280' }} /><span className="connector-sub-item-name">{c.name}</span><span className="connector-sub-item-desc">{c.desc}</span><span className="connector-sub-item-arrow"><ArrowRightSmIc /></span></button>))}
                  </div></div>
                </div>
              );
            })()}

            {(sources.length > 0 || files.length > 0) && pickerState === 'closed' && (
              <div className="source-summary-bar"><CheckCircleIc /> {(() => { const p = []; if (files.length > 0) p.push(`${files.length} file${files.length !== 1 ? 's' : ''} uploaded`); if (sources.length > 0) p.push(`${sources.length} connector${sources.length !== 1 ? 's' : ''} linked`); return p.join(' · '); })()}</div>
            )}
          </div>
        )}

        {/* ═══ Step 2: Classification ═══ */}
        {step === 2 && (
          <div className="page-body wide">
            {classifying ? (
              <div className="state-box"><Spin size="large" /><div className="state-title" style={{ marginTop: 20 }}>Classifying your data…</div><div className="state-sub">Analyzing field names, values, and patterns to infer semantic meaning</div></div>
            ) : classified ? (
              <>
                <div className="review-header">
                  <div className="review-title">Review Classification</div>
                  <div className="review-sub">Review the classification results for your uploaded files. Click a row to see field details.</div>
                </div>

                {(totalIssues > 0 || reviewCount > 0) ? (
                  <Alert
                    type="warning"
                    showIcon
                    style={{ marginBottom: 16 }}
                    message={<span style={{ fontSize: 'var(--text-sm)', fontWeight: 500 }}>
                      {totalIssues > 0 && `${totalIssues} parsing issue${totalIssues !== 1 ? 's' : ''} across ${cFiles.filter(f => f.issues > 0).length} file${cFiles.filter(f => f.issues > 0).length !== 1 ? 's' : ''}`}
                      {totalIssues > 0 && reviewCount > 0 && '  ·  '}
                      {reviewCount > 0 && `${reviewCount} field${reviewCount !== 1 ? 's' : ''} need review`}
                    </span>}
                  />
                ) : (
                  <Alert type="success" showIcon style={{ marginBottom: 16 }} message={<span style={{ fontSize: 'var(--text-sm)', fontWeight: 500 }}>All files parsed cleanly</span>} />
                )}

                <div className="search-row">
                  <Input
                    placeholder="Search files, fields, codes…"
                    prefix={<SearchOutlined style={{ color: 'var(--gray-400)' }} />}
                    allowClear
                    value={search}
                    onChange={e => setSearch(e.target.value)}
                    style={{ flex: 1 }}
                  />
                  <Select
                    value={statusFilter}
                    onChange={setStatusFilter}
                    style={{ width: 160 }}
                    options={[
                      { value: 'all', label: 'All Statuses' },
                      { value: 'review', label: 'Needs Review' },
                      { value: 'approved', label: 'Approved' },
                      { value: 'abstained', label: 'Abstained' },
                    ]}
                  />
                </div>

                {isFiltered && (
                  <div className="results-count">Showing <strong>{filteredFiles.length}</strong> of {cFiles.length} files · <strong>{filteredFieldCount}</strong> of {flat.length} fields</div>
                )}

                <div className="file-panel-header-labels">
                  <span></span><span>File</span>
                  <span style={{ textAlign: 'right' }}>Role</span>
                  <span style={{ textAlign: 'right' }}>Format</span>
                  <span style={{ textAlign: 'right' }}>Shape</span>
                  <span style={{ textAlign: 'right' }}>Status</span>
                </div>

                <Collapse
                  className="file-collapse"
                  bordered={false}
                  activeKey={expandedKeys}
                  onChange={setExpandedKeys}
                  items={collapseItems}
                />

                {filteredFiles.length === 0 && isFiltered && (
                  <div className="empty-state">
                    <div className="empty-state-text">No files or fields match your current filters</div>
                    <Button type="default" onClick={clearAllFilters}>Clear all filters</Button>
                  </div>
                )}
              </>
            ) : null}
          </div>
        )}

        {/* ═══ Step 3 ═══ */}
        {step === 3 && (
          <div className="page-body narrow">
            <div className="section-heading">Configure Output</div>
            <div className="section-sub">Select the target standard and vocabulary for this mapping profile.</div>
            <div className="form-section">
              <label className="form-label">Output Data Standard</label>
              <Select
                placeholder="Select standard…"
                value={standard || undefined}
                onChange={setStandard}
                style={{ width: '100%' }}
                size="large"
                options={standardOptions}
              />
              <div className="form-hint">The target format for transformed data output</div>
            </div>
            <div className="form-section">
              <label className="form-label">Vocabulary / Code Set</label>
              <Select
                placeholder="Select vocabulary…"
                value={vocab || undefined}
                onChange={setVocab}
                style={{ width: '100%' }}
                size="large"
                options={vocabOptions}
              />
              <div className="form-hint">The terminology system for coding clinical concepts</div>
            </div>

            {standard && vocab && (
              <div className="config-preview">
                <div className="config-preview-header"><span className="config-preview-icon"><CheckCircleIc /></span><span className="config-preview-title">Mapping Preview</span></div>
                <div className="config-preview-body">
                  <div className="config-preview-row"><span className="config-preview-label">Source</span><span className="config-preview-value">{detectedPms} — {cFiles.length} files, {flat.length} fields</span></div>
                  <div className="config-preview-row"><span className="config-preview-label">Target</span><span className="config-preview-value">{standardOptions.find(s => s.value === standard)?.label} + {vocabOptions.find(v => v.value === vocab)?.label}</span></div>
                  <div className="config-preview-row"><span className="config-preview-label">Mappable</span><span className="config-preview-value">{flat.filter(f => f.status === 'approved').length} of {flat.length} fields ready to map</span></div>
                  <div className="config-preview-row" style={{ borderBottom: 'none' }}><span className="config-preview-label">Example</span><span className="config-preview-value"><span className="field-name">{flat.find(f => f.ontologyCode)?.fieldName}</span><span style={{ color: 'var(--gray-400)', margin: '0 6px' }}>→</span><span className="preview-code">{flat.find(f => f.ontologyCode)?.ontologyCode}</span></span></div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ═══ Step 4: Graph ═══ */}
        {step === 4 && <GraphViewStep files={cFiles} fields={flat} onBack={() => setStep(3)} onContinue={() => setStep(5)} />}

        {/* ═══ Step 5 ═══ */}
        {step === 5 && (
          <div className="page-body narrow">
            {generating ? (
              <div className="state-box"><Spin size="large" /><div className="state-title" style={{ marginTop: 20 }}>Generating Mapping Profile…</div><div className="state-sub">Creating transformation rules based on your configuration</div></div>
            ) : generated ? (
              <div className="state-box"><div className="success-circle"><CheckLg /></div><div className="state-title">Mapping Profile Generated</div><div className="state-sub">Your profile is ready. Continue to name and save it.</div></div>
            ) : (
              <>
                <div className="section-heading">Generate Mapping Profile</div>
                <div className="section-sub">Review your configuration, then generate the mapping profile.</div>
                <div className="summary-card">
                  <div className="summary-card-header"><div className="summary-card-icon"><BrainIc /></div><div className="summary-card-title">Configuration Summary</div></div>
                  <div className="summary-row"><div className="summary-label">Source Files</div><div className="summary-value">{files.length} file(s)</div></div>
                  <div className="summary-row"><div className="summary-label">Source System</div><div className="summary-value">{detectedPms}</div></div>
                  <div className="summary-row"><div className="summary-label">Fields Classified</div><div className="summary-value">{flat.length} fields across {cFiles.length} files</div></div>
                  <div className="summary-row"><div className="summary-label">Output Standard</div><div className="summary-value">{standardOptions.find(s => s.value === standard)?.label}</div></div>
                  <div className="summary-row"><div className="summary-label">Vocabulary</div><div className="summary-value">{vocabOptions.find(v => v.value === vocab)?.label}</div></div>
                </div>
                <div className="generate-area">
                  <div className="generate-title">Ready to Generate</div>
                  <div className="generate-sub">This will create transformation rules for {flat.filter(f => f.status === 'approved').length} approved fields</div>
                  <Button type="primary" size="large" icon={<ExperimentOutlined />} onClick={handleGenerate} style={{ background: 'linear-gradient(135deg, #0891b2, #06b6d4)', border: 'none', height: 48, paddingInline: 28, fontWeight: 600, boxShadow: '0 4px 14px rgba(8, 145, 178, 0.3)' }}>Generate Mapping Profile</Button>
                </div>
              </>
            )}
          </div>
        )}

        {/* ═══ Step 6 ═══ */}
        {step === 6 && (
          <div className="page-body narrow">
            <div className="section-heading">Save Mapping Profile</div>
            <div className="section-sub">Give your profile a name and review the final details.</div>
            <div className="form-section">
              <label className="form-label">Profile Name</label>
              <Input
                size="large"
                value={profileName}
                onChange={e => setProfileName(e.target.value)}
                placeholder="e.g. OpenDental → FHIR R4"
              />
              <div className="form-hint">A descriptive name to identify this mapping profile</div>
            </div>
            <div className="summary-card" style={{ marginTop: 24 }}>
              <div className="summary-card-header"><div className="summary-card-icon"><CheckCircleIc /></div><div className="summary-card-title">Profile Summary</div></div>
              <div className="summary-row"><div className="summary-label">Source System</div><div className="summary-value">{detectedPms}</div></div>
              <div className="summary-row"><div className="summary-label">Output Standard</div><div className="summary-value">{standardOptions.find(s => s.value === standard)?.label}</div></div>
              <div className="summary-row"><div className="summary-label">Vocabulary</div><div className="summary-value">{vocabOptions.find(v => v.value === vocab)?.label}</div></div>
              <div className="summary-row"><div className="summary-label">Files</div><div className="summary-value">{cFiles.length} classified files</div></div>
              <div className="summary-row"><div className="summary-label">Fields</div><div className="summary-value">{flat.length} total · {flat.filter(f => f.status === 'approved').length} approved</div></div>
              <div className="summary-row"><div className="summary-label">Status</div><div className="summary-value" style={{ color: '#10b981', fontWeight: 600 }}>Generated</div></div>
            </div>
            <div className="summary-card">
              <div className="summary-card-header"><div className="summary-card-icon"><BrainIc /></div><div className="summary-card-title">Sample Mappings</div></div>
              {flat.filter(f => f.status === 'approved' && f.ontologyCode).slice(0, 4).map(f => (
                <div key={f.id} className="summary-row"><div className="summary-label"><span className="field-name">{f.fieldName}</span></div><div className="summary-value">{f.semanticLabel} → <span className="preview-code">{f.ontologyCode}</span></div></div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="footer-bar">
        <div className="footer-left">
          {step > 1 && !classifying && !generating && <Button onClick={handleBack}>← Back</Button>}
        </div>
        <div className="footer-right">
          <Button>Cancel</Button>
          {step < 6
            ? <Button type="primary" onClick={handleNext} disabled={!canNext() || classifying || generating} loading={classifying || generating}>
                {classifying ? 'Classifying…' : generating ? 'Generating…' : step === 1 ? 'Classify Data →' : 'Continue →'}
              </Button>
            : <Button type="primary" disabled={!profileName.trim()} onClick={() => alert('Profile saved!')}>Save Profile</Button>
          }
        </div>
      </div>
    </div>
    </ConfigProvider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
